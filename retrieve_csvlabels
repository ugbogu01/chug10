# Load the required package
library(flowCore)

# Define the directory for the wsp file
wspfile <- "path/to/wspfile.wsp"

# Define the directory for the FCS files
fcs_files <- "/path/to/fcs_files"

# This function returns a labels of identified cells in csv files

csvlabels <- function(wspfile, fcs_files) {

  # List all FCS files in the given directory
  fcs_file <- list.files(fcs_files, pattern = ".fcs", full.names = TRUE, recursive = TRUE)
  
  
  # Placeholder for the gating result since gatingResult is not defined
  # Remove this line when you load the actual gating result
  gatingResult <- list(matrix = matrix(data = c(TRUE, FALSE, TRUE, TRUE, FALSE, TRUE, TRUE, FALSE), nrow = 4, ncol = 2))
  colnames(gatingResult$matrix) <- c("Lymphocytes", "Single Cells")
  
  # Specify the cell types of interest for assigning one label per cell
  cellTypes <- c("CD3+")
  
  # Check the number of cells assigned to each gate (assuming 'matrix' is in gatingResult)
  cell_counts <- colSums(gatingResult$matrix)
  print(cell_counts)
  
  # Count the number of TRUE values in the "Lymphocytes" column 
  num_true <- sum(gatingResult$matrix[, "Lymphocytes"])
  print(num_true)
  
  # Save subset of Lymphocytes data to CSV file
  lymphocytes_file <- "path/to/lymphocytes.csv"
  write.csv(gatingResult$matrix[, "Lymphocytes"], lymphocytes_file, row.names = FALSE)
  
  # Define the column names to be included in the subset
  selected_columns <- c("Lymphocytes", "Single Cells", "Live", "CD3+")
  
  # Ensure the gatingResult contains the selected columns
  # Placeholder for the actual matrix with these columns
  # Assuming here that the matrix should have these columns
  gatingResult$matrix <- matrix(data = c(TRUE, TRUE, TRUE, FALSE, FALSE, TRUE, TRUE, TRUE, FALSE, TRUE, TRUE, TRUE), 
                                nrow = 4, ncol = 4)
  colnames(gatingResult$matrix) <- selected_columns
  
  # Subset the matrix to include only the specified columns
  subset_matrix <- gatingResult$matrix[, selected_columns, drop = FALSE]
  
  # Write the subset to a CSV file
  subset_file <- "path/to/cellpopulation_subset.csv"
  write.csv(subset_matrix, subset_file, row.names = FALSE)
}

# Call the function with the defined paths
csvlabels(wspfile, fcs_files)
